extends ../layout.pug

block content

    nav.navbar.navbar-expand-lg.navbar-dark.bg-black.shadow
      .container-fluid
        a.navbar-brand(href="/panel") Eventify Pro
        if user
          span.navbar-text.ms-auto #{user.name || user.email}

    .container.py-5
      h1.mb-4 Proveedores
      p.text-light-50.mb-4 Acá podés ver y crear proveedores. 
       //Los datos se guardan en Mongo usando /api/proveedores

      // FORMULARIO NUEVO PROVEEDOR
      .card.bg-secondary.border-0.shadow.mb-4
        .card-body
          h5.card-title.mb-3 Nuevo proveedor
          form#form-proveedor
            .row.g-3
              .col-md-3
                label.form-label Nombre
                input.form-control(type="text" name="nombre" required placeholder="Ej: Catering Juan")
              .col-md-2
                label.form-label Rubro
                input.form-control(type="text" name="rubro" placeholder="Catering, sonido, etc.")
              .col-md-2
                label.form-label Teléfono
                input.form-control(type="text" name="telefono" placeholder="Ej: 261 555 5555")
              .col-md-2
                label.form-label Costo
                input.form-control(type="number" name="costo" min="0" step="1" placeholder="0")
              .col-md-3
                label.form-label Evento
                select.form-select(name="evento" id="select-evento-proveedor")
                  option(value="") Seleccioná un evento
            button.btn.btn-light.mt-3(type="submit") Guardar proveedor

      // TABLA
      .card.bg-secondary.border-0.shadow
        .card-body
          h5.card-title.mb-3 Lista de proveedores
          table.table.table-dark.table-striped.mb-0
            thead
              tr
                th Nombre
                th Rubro
                th Teléfono
                th Costo
                th Evento
            tbody#tabla-proveedores
              tr
                td(colspan="5") Cargando proveedores...

      .mt-4
        a.btn.btn-outline-light(href="/panel") Volver al panel

      // PANEL DE DETALLE
      .card.bg-secondary.border-0.shadow.mt-4
        .card-body
          h5.card-title.mb-3 Detalle del proveedor
          p.text-light-50#detalle-msg Seleccioná un proveedor de la tabla para ver sus datos.

          form#form-detalle-proveedor(class="d-none")
            input(type="hidden" name="id")
            .row.g-3
              .col-md-3
                label.form-label Nombre
                input.form-control(type="text" name="nombre")
              .col-md-2
                label.form-label Rubro
                input.form-control(type="text" name="rubro")
              .col-md-2
                label.form-label Teléfono
                input.form-control(type="text" name="telefono")
              .col-md-2
                label.form-label Costo
                input.form-control(type="number" name="costo" min="0" step="1")
              .col-md-3
                label.form-label Evento
                select.form-select(name="evento" id="detalle-evento-proveedor")
                  option(value="") Seleccioná un evento
            .mt-3.d-flex.gap-2
              button.btn.btn-light(type="submit") Guardar cambios
              button.btn.btn-outline-danger#btn-borrar-proveedor(type="button") Eliminar proveedor

    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js")
    script.
      let mapaEventosProv = {};

      async function cargarMapaEventosProv() {
        try {
          const res = await fetch('/api/eventos');
          if (!res.ok) return;
          const eventos = await res.json();
          mapaEventosProv = {};
          eventos.forEach(e => {
            mapaEventosProv[e._id] = e.nombre || e.titulo || e._id;
          });

          const selectNuevo = document.getElementById('select-evento-proveedor');
          const selectDetalle = document.getElementById('detalle-evento-proveedor');

          [selectNuevo, selectDetalle].forEach(sel => {
            if (!sel) return;
            sel.innerHTML = '<option value="">Seleccioná un evento</option>';
            eventos.forEach(e => {
              const opt = document.createElement('option');
              opt.value = e._id;
              opt.textContent = e.nombre || e.titulo || e._id;
              sel.appendChild(opt);
            });
          });
        } catch (err) {
          console.error("Error al cargar eventos para proveedores:", err);
        }
      }

      async function cargarProveedores() {
        const tbody = document.getElementById('tabla-proveedores');
        tbody.innerHTML = '<tr><td colspan="5">Cargando proveedores...</td></tr>';

        try {
          await cargarMapaEventosProv();

          const res = await fetch('/api/proveedores');
          if (!res.ok) {
            tbody.innerHTML = '<tr><td colspan="5">Error al cargar proveedores</td></tr>';
            return;
          }
          const proveedores = await res.json();

          if (!proveedores.length) {
            tbody.innerHTML = '<tr><td colspan="5">No hay proveedores cargados.</td></tr>';
            return;
          }

          tbody.innerHTML = '';
          proveedores.forEach(p => {
            const tr = document.createElement('tr');
            tr.style.cursor = 'pointer';
            tr.dataset.id = p._id;

            const nombreEvento = p.evento ? (mapaEventosProv[p.evento] || p.evento) : '';

            tr.innerHTML = `
              <td>${p.nombre || ''}</td>
              <td>${p.rubro || ''}</td>
              <td>${p.telefono || ''}</td>
              <td>${p.costo ?? 0}</td>
              <td>${nombreEvento}</td>
            `;

            tr.addEventListener('click', () => seleccionarProveedor(p._id));
            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error(err);
          tbody.innerHTML = '<tr><td colspan="5">Error al cargar proveedores.</td></tr>';
        }
      }

      async function crearProveedor(e) {
        e.preventDefault();
        const form = e.target;
        const data = {
          nombre: form.nombre.value,
          rubro: form.rubro.value,
          telefono: form.telefono.value,
          costo: form.costo.value,
          evento: form.evento.value
        };

        try {
          const res = await fetch('/api/proveedores', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          if (!res.ok) {
            alert('Error al guardar el proveedor');
            return;
          }

          form.reset();
          cargarProveedores();
        } catch (err) {
          console.error(err);
          alert('Error inesperado al guardar el proveedor');
        }
      }

      async function seleccionarProveedor(id) {
        const msg = document.getElementById('detalle-msg');
        const formDetalle = document.getElementById('form-detalle-proveedor');
        const elems = formDetalle.elements;

        try {
          const res = await fetch(`/api/proveedores/${id}`);
          if (!res.ok) {
            msg.textContent = 'No se pudo cargar el detalle del proveedor.';
            formDetalle.classList.add('d-none');
            return;
          }

          const p = await res.json();

          msg.textContent = 'Podés editar los datos del proveedor o eliminarlo.';
          formDetalle.classList.remove('d-none');

          elems.id.value = p._id;
          elems.nombre.value = p.nombre || '';
          elems.rubro.value = p.rubro || '';
          elems.telefono.value = p.telefono || '';
          elems.costo.value = p.costo ?? 0;
          elems.evento.value = p.evento || '';
        } catch (err) {
          console.error(err);
          msg.textContent = 'Error al cargar el detalle del proveedor.';
          formDetalle.classList.add('d-none');
        }
      }

      async function guardarCambiosProveedor(e) {
        e.preventDefault();
        const form = e.target;
        const elems = form.elements;
        const id = elems.id.value;

        const data = {
          nombre: elems.nombre.value,
          rubro: elems.rubro.value,
          telefono: elems.telefono.value,
          costo: elems.costo.value,
          evento: elems.evento.value
        };

        try {
          const res = await fetch(`/api/proveedores/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          if (!res.ok) {
            alert('Error al actualizar el proveedor');
            return;
          }

          alert('Proveedor actualizado correctamente');
          cargarProveedores();
        } catch (err) {
          console.error(err);
          alert('Error inesperado al actualizar el proveedor');
        }
      }

      async function borrarProveedor() {
        const form = document.getElementById('form-detalle-proveedor');
        const elems = form.elements;
        const id = elems.id.value;
        if (!id) return;

        if (!confirm('¿Seguro que querés eliminar este proveedor?')) return;

        try {
          const res = await fetch(`/api/proveedores/${id}`, {
            method: 'DELETE'
          });

          if (!res.ok) {
            alert('Error al eliminar el proveedor');
            return;
          }

          alert('Proveedor eliminado');
          form.classList.add('d-none');
          document.getElementById('detalle-msg').textContent = 'Seleccioná un proveedor de la tabla para ver sus datos.';
          cargarProveedores();
        } catch (err) {
          console.error(err);
          alert('Error inesperado al eliminar el proveedor');
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        const formNuevo = document.getElementById('form-proveedor');
        formNuevo.addEventListener('submit', crearProveedor);

        const formDetalle = document.getElementById('form-detalle-proveedor');
        formDetalle.addEventListener('submit', guardarCambiosProveedor);

        const btnBorrar = document.getElementById('btn-borrar-proveedor');
        btnBorrar.addEventListener('click', borrarProveedor);

        cargarProveedores();
      });
