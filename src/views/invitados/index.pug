extends ../layout.pug

block content
    nav.navbar.navbar-expand-lg.navbar-dark.bg-black.shadow
      .container-fluid
        a.navbar-brand(href="/panel") Eventify Pro
        if user
          span.navbar-text.ms-auto #{user.name || user.email}

    .container.py-5
      h1.mb-4 Invitados
      p.text-light-50.mb-4 Acá podés ver y crear invitados. 
      //Los datos se guardan en Mongo usando /api/invitados.

      // FORMULARIO NUEVO INVITADO
      .card.bg-secondary.border-0.shadow.mb-4
        .card-body
          h5.card-title.mb-3 Nuevo invitado
          form#form-invitado
            .row.g-3
              .col-md-3
                label.form-label Nombre
                input.form-control(type="text" name="nombre" required placeholder="Ej: Juan Pérez")
              .col-md-3
                label.form-label Email
                input.form-control(type="email" name="email" required placeholder="juan@mail.com")
              .col-md-3
                label.form-label Evento
                select.form-select(name="evento" id="select-evento-invitado")
                  option(value="") Sin evento
              .col-md-3
                label.form-label Estado
                select.form-select(name="estado")
                  option(value="pendiente" selected) pendiente
                  option(value="confirmado") confirmado
                  option(value="rechazado") rechazado
            button.btn.btn-light.mt-3(type="submit") Guardar invitado

      // TABLA
      .card.bg-secondary.border-0.shadow
        .card-body
          h5.card-title.mb-3 Lista de invitados
          table.table.table-dark.table-striped.mb-0
            thead
              tr
                th Nombre
                th Email
                th Evento
                th Estado
            tbody#tabla-invitados
              tr
                td(colspan="4") Cargando invitados...

      .mt-4
        a.btn.btn-outline-light(href="/panel") Volver al panel

      // PANEL DE DETALLE
      .card.bg-secondary.border-0.shadow.mt-4
        .card-body
          h5.card-title.mb-3 Detalle del invitado
          p.text-light-50#detalle-msg Seleccioná un invitado de la tabla para ver sus datos.

          form#form-detalle-invitado(class="d-none")
            input(type="hidden" name="id")
            .row.g-3
              .col-md-3
                label.form-label Nombre
                input.form-control(type="text" name="nombre")
              .col-md-3
                label.form-label Email
                input.form-control(type="email" name="email")
              .col-md-3
                label.form-label Evento
                select.form-select(name="evento" id="detalle-evento-invitado")
                  option(value="") Sin evento
              .col-md-3
                label.form-label Estado
                select.form-select(name="estado")
                  option(value="pendiente") pendiente
                  option(value="confirmado") confirmado
                  option(value="rechazado") rechazado
            .mt-3.d-flex.gap-2
              button.btn.btn-light(type="submit") Guardar cambios
              button.btn.btn-danger.ms-auto#btn-borrar-invitado(type="button") Eliminar invitado

    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js")
    script.
      let mapaEventosInv = {};

      async function cargarMapaEventosInv() {
        try {
          const res = await fetch('/api/eventos');
          if (!res.ok) return;

          const eventos = await res.json();
          mapaEventosInv = {};
          eventos.forEach(e => {
            mapaEventosInv[e._id] = e.nombre || e.titulo || e._id;
          });

          const selectNuevo = document.getElementById('select-evento-invitado');
          const selectDetalle = document.getElementById('detalle-evento-invitado');

          [selectNuevo, selectDetalle].forEach(sel => {
            if (!sel) return;
            sel.innerHTML = '<option value=\"\">Sin evento</option>';
            eventos.forEach(e => {
              const opt = document.createElement('option');
              opt.value = e._id;
              opt.textContent = e.nombre || e.titulo || e._id;
              sel.appendChild(opt);
            });
          });
        } catch (err) {
          console.error('Error al cargar eventos para invitados:', err);
        }
      }

      async function cargarInvitados() {
        const tbody = document.getElementById('tabla-invitados');
        tbody.innerHTML = '<tr><td colspan="4">Cargando invitados...</td></tr>';

        try {
          await cargarMapaEventosInv();

          const res = await fetch('/api/invitados');
          if (!res.ok) {
            tbody.innerHTML = '<tr><td colspan="4">Error al cargar invitados</td></tr>';
            return;
          }
          const invitados = await res.json();

          if (!invitados.length) {
            tbody.innerHTML = '<tr><td colspan="4">No hay invitados cargados.</td></tr>';
            return;
          }

          tbody.innerHTML = '';
          invitados.forEach(i => {
            const tr = document.createElement('tr');
            tr.style.cursor = 'pointer';
            tr.dataset.id = i._id;

            const nombreEvento = i.evento ? (mapaEventosInv[i.evento] || i.evento) : '';

            tr.innerHTML = `
              <td>${i.nombre || ''}</td>
              <td>${i.email || ''}</td>
              <td>${nombreEvento}</td>
              <td>${i.estado || 'pendiente'}</td>
            `;

            tr.addEventListener('click', () => seleccionarInvitado(i._id));
            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error(err);
          tbody.innerHTML = '<tr><td colspan="4">Error al cargar invitados.</td></tr>';
        }
      }

      async function crearInvitado(e) {
        e.preventDefault();
        const form = e.target;
        const data = {
          nombre: form.nombre.value,
          email: form.email.value,
          evento: form.evento.value || '',
          estado: form.estado.value || 'pendiente'
        };

        try {
          const res = await fetch('/api/invitados', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          if (!res.ok) {
            alert('Error al guardar el invitado');
            return;
          }

          form.reset();
          cargarInvitados();
        } catch (err) {
          console.error(err);
          alert('Error inesperado al guardar el invitado');
        }
      }

      async function seleccionarInvitado(id) {
        const msg = document.getElementById('detalle-msg');
        const formDetalle = document.getElementById('form-detalle-invitado');
        const elems = formDetalle.elements;

        try {
          const res = await fetch(`/api/invitados/${id}`);
          if (!res.ok) {
            msg.textContent = 'No se pudo cargar el detalle del invitado.';
            formDetalle.classList.add('d-none');
            return;
          }

          const i = await res.json();

          msg.textContent = 'Podés editar los datos del invitado o eliminarlo.';
          formDetalle.classList.remove('d-none');

          elems.id.value = i._id;
          elems.nombre.value = i.nombre || '';
          elems.email.value = i.email || '';
          elems.evento.value = i.evento || '';
          elems.estado.value = i.estado || 'pendiente';
        } catch (err) {
          console.error(err);
          msg.textContent = 'Error al cargar el detalle del invitado.';
          formDetalle.classList.add('d-none');
        }
      }

      async function guardarCambiosInvitado(e) {
        e.preventDefault();
        const form = e.target;
        const elems = form.elements;
        const id = elems.id.value;

        const data = {
          nombre: elems.nombre.value,
          email: elems.email.value,
          evento: elems.evento.value || '',
          estado: elems.estado.value || 'pendiente'
        };

        try {
          const res = await fetch(`/api/invitados/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          if (!res.ok) {
            alert('Error al actualizar el invitado');
            return;
          }

          alert('Invitado actualizado correctamente');
          cargarInvitados();
        } catch (err) {
          console.error(err);
          alert('Error inesperado al actualizar el invitado');
        }
      }

      async function borrarInvitado() {
        const form = document.getElementById('form-detalle-invitado');
        const elems = form.elements;
        const id = elems.id.value;
        if (!id) return;

        if (!confirm('¿Seguro que querés eliminar este invitado?')) return;

        try {
          const res = await fetch(`/api/invitados/${id}`, {
            method: 'DELETE'
          });

          if (!res.ok) {
            alert('Error al eliminar el invitado');
            return;
          }

          alert('Invitado eliminado');
          form.classList.add('d-none');
          document.getElementById('detalle-msg').textContent = 'Seleccioná un invitado de la tabla para ver sus datos.';
          cargarInvitados();
        } catch (err) {
          console.error(err);
          alert('Error inesperado al eliminar el invitado');
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        const formNuevo = document.getElementById('form-invitado');
        formNuevo.addEventListener('submit', crearInvitado);

        const formDetalle = document.getElementById('form-detalle-invitado');
        formDetalle.addEventListener('submit', guardarCambiosInvitado);

        const btnBorrar = document.getElementById('btn-borrar-invitado');
        btnBorrar.addEventListener('click', borrarInvitado);

        cargarInvitados();
      });
